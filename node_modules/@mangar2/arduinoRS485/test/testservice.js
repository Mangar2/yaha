/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2020 Volker Böhm
 */

'use strict'
const Message = require('@mangar2/message')
const { delay } = require('@mangar2/utils')

const ArduinoRS485 = require('../arduinors485')
const arduinoService = new ArduinoRS485(
    {
        serialPortName: 'COM11',
        addresses: {
            'myfloor/myroom1/mydevice/': 20,
            'myfloor/myroom2/mydevice/': 21,
            'myfloor/myroom3/mydevice/': 22
        }
    }
)

arduinoService.on('publish', (message) => {
    console.log('%s = %s', message.topic, message.value)
})

const main = async () => {
    await arduinoService.run()
    await delay(20000, true)
    const traceMessage = new Message('$SYS/arduinoRS485/trace/set', 'messages')
    arduinoService.processMessage(traceMessage)
    let message = new Message('myfloor/myroom1/mydevice/Arduino base settings/reporting delay in seconds/set', 1)
    arduinoService.processMessage(message)
    await delay(20000, true)
    message = new Message('myfloor/myroom1/mydevice/Arduino base settings/reporting delay in seconds/set', 4)
    arduinoService.processMessage(message)
    await delay(20000, true)
    // arduinoService.close()
}

main()
