<!-- This file is generated by jsmddoc version 0.1 -->

# Abstract

JSON schema to check configuration input

Default values

Checks the configuration and sets default values

Provides an automation functionality based on JSON formatted automation rules

Watches rule files and reloads them on change

## Contents

- [Meta](#Meta)
- [Global Functions](#Global-functions)
  - [prepare](#prepare)
  - [readRulesFromFileStore](#readRulesFromFileStore)
  - [saveRulesToFileStore](#saveRulesToFileStore)
- [Class Automation](#Class-Automation)
  - [Parameters](#Automation-Parameters)
  - [Members](#Automation-Members)
  - [Methods](#Automation-Methods)
    - [_handleRuleMessage](#_handleRuleMessage)
    - [_setRuleFromValue](#_setRuleFromValue)
    - [getSubscriptions](#getSubscriptions)
    - [handleMessage](#handleMessage)
    - [processTasks](#processTasks)
    - [setRules](#setRules)
- [Class EventHistory](#Class-EventHistory)
  - [Methods](#EventHistory-Methods)
    - [addEvent](#addEvent)
    - [clear](#clear)
    - [clearNonMotionEvents](#clearNonMotionEvents)
    - [getLatestEvents](#getLatestEvents)

## Meta

| | |
| --- | --- |
| **File** | index.js |
| **Abstract** | Provides an automation functionality based on JSON formatted automation rules |
| **Author** | Volker Böhm |
| **Copyright** | Copyright ( c ) 2020 Volker Böhm |
| **License** | This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3 . It is furnished "as is" , without any support , and with no warranty , express or implied , as to its usefulness for any purpose . |

## Global functions

### prepare

`async prepare (config, automation) => {Automation}`

Prepares the automation

#### prepare Parameters

| Name | Type | Attribute | Default | Description |
| ---------- | ------------ | ------------ | ------------ | ----------------- |
| `config` | `Object` |  |  | automation configuration | |
| `automation` | `Automation` | optional | null | existing automation class | |

#### prepare returns

| Type | Description |
| ---- | ----------- |
| `Automation` | the prepared automation object |

### readRulesFromFileStore

`async readRulesFromFileStore (filestoreOptions) => {object, null}`

Reads all rules from filestore

#### readRulesFromFileStore Parameters

| Name | Type |
| ---------- | ------------ |
| `filestoreOptions` | `object` | |

#### filestoreOptions properties

| Name | Type | Description |
| ---------- | ------------ | ----------------- |
| `port` | `string` | port of the filestore | |
| `host` | `string` | host of the filestore | |
| `path` | `string` | path to store the data to | |
| `use` | `boolean` | true , if filestore shall be used | |

#### readRulesFromFileStore returns

| Type | Description |
| ---- | ----------- |
| `object, null` | rules read |

### saveRulesToFileStore

`async saveRulesToFileStore (rules, filestoreOptions)`

Stores all rules to the filestore

#### saveRulesToFileStore Parameters

| Name | Type | Description |
| ---------- | ------------ | ----------------- |
| `rules` | `object` | list of rules to store | |
| `filestoreOptions` | `object` |  | |

#### filestoreOptions properties

| Name | Type | Description |
| ---------- | ------------ | ----------------- |
| `port` | `string` | port of the filestore | |
| `host` | `string` | host of the filestore | |
| `path` | `string` | path to store the data to | |

## Class Automation

`new Automation(configuration)`

Creates an automation class . Automation is a automation rule processor This class is designed to work togehter with the runservices service to provide event based automations .

### Automation Parameters

| Name | Type |
| ---------- | ------------ |
| `configuration` | `Object` | |

#### configuration properties

| Name | Type | Attribute | Default | Description |
| ---------- | ------------ | ------------ | ------------ | ----------------- |
| `motionTopics` | `Array` | optional |  | list of topics to subscribe to see all motions | |
| `presenceVariable` | `string` | optional | '$SYS/presence' | name of the variable to store the presence flag | |
| `subscribeQoS` | `number` | optional | 1 | quality of service for message subscription | |
| `longitued` | `number` |  |  | longitude of the place to automate | |
| `latitude` | `number` |  |  | latitude of the place to automate | |

### Automation Members

| Name | Type | description |
| ------------ | ------------ | ------------ |
| `filestoreOptions` | `@type` | Gets the sanitized options for the filestore |

### Automation Methods

#### _handleRuleMessage

`_handleRuleMessage (message)`

Adds or deletes a rule based on a rule update message

##### _handleRuleMessage Parameters

| Name | Type |
| ---------- | ------------ |
| `message` | `Message` | |

#### _setRuleFromValue

`_setRuleFromValue (value, ruleName) => {Array.<Message>}`

Sets a rule from a set rule message

##### _setRuleFromValue Parameters

| Name | Type | Description |
| ---------- | ------------ | ----------------- |
| `value` | `string` | value of a set rule message | |
| `ruleName` | `string` | name of the rule | |

##### _setRuleFromValue returns

| Type | Description |
| ---- | ----------- |
| `Array.<Message>` | result messages |

#### getSubscriptions

`getSubscriptions () => {Array.<string>}`

Get all the variables to subscribe to

##### getSubscriptions returns

| Type | Description |
| ---- | ----------- |
| `Array.<string>` | array of subscriptions |

#### handleMessage

`handleMessage (mqttMessage) => {Array.<Message>}`

Fully handles an mqtt message

##### handleMessage Parameters

| Name | Type | Description |
| ---------- | ------------ | ----------------- |
| `mqttMessage` | `Message` | the received mqtt message | |

##### handleMessage returns

| Type | Description |
| ---- | ----------- |
| `Array.<Message>` | array of reply messages |

#### processTasks

`processTasks (date) => {Array.<Message>}`

Loops through all rules and processes them

##### processTasks Parameters

| Name | Type | Attribute | Description |
| ---------- | ------------ | ------------ | ----------------- |
| `date` | `Date` | optional | current date/time | |

##### processTasks returns

| Type | Description |
| ---- | ----------- |
| `Array.<Message>` | list of messages to process |

#### setRules

`setRules (rulesTree)`

Sets/replaces the rules tree

##### setRules Parameters

| Name | Type | Description |
| ---------- | ------------ | ----------------- |
| `rulesTree` | `Object` | tree with 'rules' elements | |

## Class EventHistory

`new EventHistory()`

Creates a motion history object . It stores motion messages in a list and provides the function to get a list of recent motions .

### EventHistory Methods

#### addEvent

`addEvent (message, isMotion)`

Checks a message for motions and if a motion is included adds it to the motion list

##### addEvent Parameters

| Name | Type | Attribute | Description |
| ---------- | ------------ | ------------ | ----------------- |
| `message` | `Message` |  | received message | |
| `isMotion` | `boolean` | optional | true , if the message is a motion message | |

#### clear

`clear ()`

Deletes all event entries

#### clearNonMotionEvents

`clearNonMotionEvents ()`

Clears all non motion events

#### getLatestEvents

`getLatestEvents (relatedMotionTimespanInSeconds) => {Object}`

Gets the last motion and all "related" motions . A motion is "related" , if it happend nearly at the same time

##### getLatestEvents Parameters

| Name | Type | Attribute | Default | Description |
| ---------- | ------------ | ------------ | ------------ | ----------------- |
| `relatedMotionTimespanInSeconds` | `number` | optional | 5 | time in seconds when a motion is a related motion | |

##### getLatestEvents returns

| Type | Description |
| ---- | ----------- |
| `Object` | { timestamp , motions , displayString } timestamp is the latest motion , motions is an Object containing a map of topic : timestamp and displayString is a string to visualize the motions in a log |
