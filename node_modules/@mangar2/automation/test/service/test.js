/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2023 Volker Böhm
 */
'use strict'

const VERBOSE = true

const Message = require('@mangar2/message')
const { prepare } = require('@mangar2/automation')

const Testrun = require('@mangar2/testrun')
const testrun = new Testrun(VERBOSE)

testrun.on('prepare', async testcase => {
    const automation = await prepare(testcase.config)
    return automation
})


const runTest = (test, automation) => {
    if (test.rules) {
        automation.setRules(test.rules)
    }
    let messages
    if (test.message) {
        const mqttMessage = new Message(test.message.topic, test.message.value, test.message.reason)
        mqttMessage.qos = test.message.qos ? test.message.qos : 1
        messages = automation.handleMessage(mqttMessage)
    } else {
        messages = automation.processTasks().messages
    }
    const subscriptions = automation.getSubscriptions()
    return { 
        automation,
        subscriptions,
        messages
    }
}

testrun.on('run', runTest)

testrun.on('break', async (test, automation) => {
    runTest(test, automation)
})


console.log('running history test')
testrun.asyncRun(['service'], __dirname, 9, 'js')
