/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2020 Volker Böhm
 */

'use strict'

const { HttpClient, EchoServer } = require('@mangar2/httpservice')

const Testrun = require('@mangar2/testrun')
const VERBOSE = true
const DEBUG = true

const testRun = new Testrun(VERBOSE, DEBUG)
const echoServer = new EchoServer(0)
echoServer.run()

testRun.on('break', () => {
    testRun.unitTest.log('break')
})

testRun.on('prepare', async (testcase) => {
    const client = new HttpClient('localhost', echoServer.port, testcase.type)
    return client
})

testRun.on('run', async (test, testObject) => {
    const client = testObject
    const callResult = await client.sendv2(test.options)
    let callPayload
    if (callResult.headers['content-type'] === 'application/json') {
        callPayload = JSON.parse(callResult.payload)
        if (test.options.type === 'json') {
            callPayload.payload = JSON.parse(callPayload.payload)
        }
    } else {
        callPayload = callResult.payload
    }
    return callPayload
})

testRun.on('followup', async() => {
    echoServer.stop()
}) 


testRun.asyncRun(['testcases'], __dirname, 4, 'js')

