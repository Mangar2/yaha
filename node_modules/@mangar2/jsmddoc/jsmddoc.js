/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2020 Volker Böhm
 * @overview This module provides a parser and a generator to parse JSDOC tags in
 * JavaScript files and generates a markdown based on a user-defined template. It scans the
 * provided directory and generates one markdown file for all .js files in this directory
 * @example
 * // jsmddoc directory outputfile
 * jsmddoc . README.md
 */
'use strict'

const Tokenizer = require('./tokenizer')
const Parse = require('./parse')
const Generate = require('./generate')
const Template = require('./template.json')
const types = require('@mangar2/types')

const fs = require('fs')
const path = require('path')

/**
 * @private
 * @description
 * Gets the command line parameters as object (Key/value)
 * @param {Array} requiredArgs list of required arguments
 * @param {Array} whiteList list of supported additional arguments (--name value)
 * @returns {Object} object with key/value
 */
function getCommandLineParameters (requiredArgs = [], whiteList = []) {
    const result = {}
    const args = [...process.argv]
    // remove executable and file
    args.shift()
    args.shift()
    for (const argName of requiredArgs) {
        if (!types.isString(args[0]) || args[0].startsWith('--')) {
            break
        }
        result[argName] = args.shift()
    }
    for (const argument of args) {
        let argName
        if (argument.startsWith('--')) {
            argName = argument.substring(2)
            result[argName] = ''
        } else if (types.isString(argName) && whiteList.includes(argName)) {
            result[argName] = argument
        }
    }
    return result
}

/**
 * @private
 * @description
 * Reads a directory and sorts it
 * @param {string} directory directory to read and sort files
 * @returns {promise} sorted list of files
 */
function readDir (directory) {
    const directoryContent = fs.readdirSync(directory)
    return directoryContent
}

const parameters = getCommandLineParameters(['directory', 'outputFile'])

if (parameters.directory === undefined) {
    parameters.directory = __dirname
}

const files = readDir(parameters.directory)
let parseResult

for (const file of files) {
    if (file.endsWith('.js')) {
        const pathAndName = path.join(parameters.directory, file)
        console.log('Parsing file %s', pathAndName)
        const content = fs.readFileSync(pathAndName, 'utf-8')
        const tokenizer = new Tokenizer(file, content)
        const parse = new Parse(tokenizer)
        parseResult = parse.getJSON(parseResult)
    }
}
const generate = new Generate(Template)
const md = generate.generate(parseResult)

if (parameters.outputFile === undefined) {
    console.log(md)
} else {
    const outputFile = parameters.outputFile
    fs.writeFileSync(outputFile, md, { flag: 'w' })
}
