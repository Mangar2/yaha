/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2020 Volker Böhm
 */

import { Types } from "@mangar2/utils";
import { IResult, RequestData, standardHeaderJSON } from "./interfaces";

/**
 * Type representing the connection options
 */
export interface IConnectOptions {
    clientId: string;
    host: string;
    port: number;
    clean: boolean;
    keepAlive?: number; // keepalive time in seconds
}

/**
 * Type representing the onConnect options
 * @private
 * @interface
 * @param { number } present - 1 if the client is already present
 * @param { string } token - token for the client
 */
export interface IOnConnectOptions {
    present: number;
    token: string;
}


/**
 * Connection function interface.
 */
interface ConnectionFunction {
    (options: IConnectOptions): RequestData
}

/**
 * Connect functions mapped by their version numbers
 * @private
 */
export const connect: Record<string, ConnectionFunction> = {
    '0.0': (options: IConnectOptions) => {
        const { clientId, host, port, clean } = options;
        const payload = {
            clientId, host, port, clean
        };
        const headers = { ...standardHeaderJSON, version: '0.0' };

        const resultCheck = (result: IResult) => {
            return result.statusCode === 200 &&
                Types.isString(result.headers['content-type']) &&
                result.headers['content-type'].startsWith('text/plain') &&
                result.payload.toLowerCase() === 'connack';
        }

        return { headers, payload, resultCheck };
    },

    '1.0': (options: IConnectOptions) => {
        const { clientId, host, port, clean, keepAlive = 0 } = options;
        const payload = {
            clientId, host, port, clean, keepAlive
        };
        const headers = { ...standardHeaderJSON, version: '1.0' };

        const resultCheck = (result: IResult) => {
            return result.statusCode === 200 &&
                Types.isString(result.headers['content-type']) &&
                result.headers['content-type'].startsWith('application/json') &&
                result.headers.packet === 'connack';
        }

        return { headers, payload, resultCheck };
    }
}

/**
 * Connection response interface.
 */
interface ConnectionResponseFunction {
    (payload: IOnConnectOptions): IResult
}

/**
 * OnConnect functions mapped by their version numbers
 * @private
 */
export const onConnect: Record<string, ConnectionResponseFunction> = {
    '0.0': () => {
        return {
            headers: { 'content-type': 'text/plain; charset=UTF-8', version: '0.0' },
            payload: 'connack',
            statusCode: 200
        };
    },

    '1.0': (payload: IOnConnectOptions) => {
        return {
            headers: { 'content-type': 'application/json; charset=UTF-8', packet: 'connack', version: '1.0' },
            payload: JSON.stringify(payload),
            statusCode: 200
        };
    }
}

