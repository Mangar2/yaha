/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2020 Volker Böhm
 */

import { IResult, IResultWithPacketid, RequestData, standardHeaderText, headers_t } from "./interfaces"


/**
 * Interface representing the options for pubrel function.
 */
interface IPubrelOptions {
    token: string,
    packetid?: number
}

/**
 * Creates the objects for a qos=2 commit message "pubcomp".
 */
export const pubrel: Record<string, (options: IPubrelOptions) => RequestData> = {
    '0.0': ({ token, packetid }) => {
        const payload = { token };
        const headers: Record<string, string> = { ...standardHeaderText, version: '0.0' };
        const packetidStr = packetid ? packetid.toString() : undefined;
        if (packetidStr !== undefined) {
            headers.id = packetidStr;
        }

        const resultCheck = (result: IResult) => {
            return result.statusCode === 200 &&
                result.headers['content-type'].startsWith('text/plain') &&
                result.payload.toLowerCase() === 'pubcomp' &&
                result.headers.id === packetidStr;
        }

        return { headers, payload, resultCheck };
    },

    '1.0': ({ token, packetid }) => {
        const payload = { token };
        const headers: Record<string, string> = { ...standardHeaderText, version: '1.0' };
        const packetidStr = packetid ? packetid.toString() : undefined;
        if (packetidStr !== undefined) {
            headers.packetid = packetidStr;
        }

        const resultCheck = (result: IResult) => {
            const statusOk = result.statusCode === 204;
            const packetIdMatches = result.headers.packetid === packetidStr;
            const packetNameOk = result.headers.packet === 'pubcomp';
            return statusOk && packetIdMatches && packetNameOk;
        }
        return { headers, payload, resultCheck };
    }
}

/**
 * Publish response interface.
 */
interface PurelResponseFunction {
    (headers: headers_t): IResult 
}

/**
 * Creates the return types for a receive pubrel message.
 */
export const onPubrel: Record<string, PurelResponseFunction> = {
    '0.0': headers => {
        const version = '0.0';
        const packetid = headers.id;

        const result: IResultWithPacketid = {
            headers: { 'content-type': 'text/plain; charset=UTF-8', version, packetid },
            payload: 'pubcomp',
            statusCode: 200,
            packetid: Number(packetid)
        };
        return result;
    },
    '1.0': headers => {
        const version = '1.0';
        const packet = 'pubcomp';
        const packetid = headers.packetid;

        const result: IResultWithPacketid = {
            headers: { 'content-type': 'text/plain; charset=UTF-8', version, packet, packetid },
            payload: '',
            statusCode: 204,
            packetid: Number(packetid)
        };
        return result;
    }
}



