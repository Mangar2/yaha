const Interface = require("@mangar2/mqtt");
const UnitTest = require("@mangar2/unittest");

var interface = new Interface({directory: ".", fileName: "connections", timeoutInMilliseconds: 500});

var unitTest = new UnitTest(true);

async function processAllMessages() {
    let packets = {publish: 0, pubrel: 0};
    interface.processSendMessage(async (host, port, packet, payload, headers) => {
        let {message, token} = payload;
        packets[packet]++;
        unitTest.assertEqual(host, "host0", "host name");
        unitTest.assertEqual(port, 9001, "port number");
        if (packet === 'publish') {
            headers.packet = headers.qos == 2 ? 'pubrec' : 'puback';
            unitTest.assertEqual(headers.qos, message.topic === '/b/2' ? 2 : 1, "QoS");
            unitTest.assertEqual(message.value, "1.0", "message value");
        } else {
            headers.packet = 'pubcomp'
        }
        unitTest.assertEqual(token, "receive/a/b", "token");
        return {statusCode: 204, headers, payload: {}};
    });
    await unitTest.delay(1000);
    
    return packets;
}

(async function testInterface() {    
    let result;
    let token;
    
    result = interface.processRequest("connect", {clientId: "/a/b", host: "host0", port: 9001, clean: true}, {version: '1.0'});
    token = JSON.parse(result.payload).token.send;
    unitTest.assertEqual(result.statusCode, 200, "http code ok");
    unitTest.assertEqual(JSON.parse(result.payload).present, 0, "no older session");

    result = interface.processRequest("disconnect", {clientId: "/a/b"}, {version: '1.0'});
    unitTest.assertEqual(result.statusCode, 204, "disconnect, http code ok");

    result = interface.processRequest("subscribe",
        {clientId: "/a/b", topics: {topic1: 1, topic2: 0, topic3: 2}},
        {packetid: 1, version: "1.0"}
        );
    unitTest.assertEqual(typeof(result.payload), 'string', "subscribe without connected 1");    
    unitTest.assertEqual(JSON.parse(result.payload).qos[0], 0x80, "subscribe without connected 2");    

    result = interface.processRequest("connect", {clientId: "/a/b", host: "host0", port: 9001, clean: true}, {version: '1.0'});
    token = JSON.parse(result.payload).token.send;
    result = interface.processRequest("subscribe",
        {clientId: "/a/b", topics: {topic1: 1, topic2: 0, topic3: 2}},
        {packetid: 1, version: '1.0'}
        );
    unitTest.assertEqual(JSON.parse(result.payload).qos[0], 1, "subscribe 1");        

    result = interface.processRequest("subscribe", 
        {clientId: "/a/b", subscribe: {QoS:1, topics:["topic1", "topic2", "topic32"]}},
        {packetid: 2, version: '1.0'}
        );
    unitTest.assertEqual(JSON.parse(result.payload).qos[1], 1, "subscribe 2");     
    result = interface.processRequest("unsubscribe", {clientId: "/a/b", topics: ["topic1", "topic2", "topic3"]}, {version: '1.0'});
    
    result = interface.processRequest("log", [{topic: "b/b", module: "send"}, { topic: "/b/c", module: "all"}]);    

    result = interface.processRequest("subscribe", 
        {clientId: "/a/b", topics: {"/b/#": 1, "/b/2": 2}},
        {packetid: 3, version: '1.0'}
        );
    unitTest.assertEqual(JSON.parse(result.payload).qos[0], 1, "subscribe 3");   

    /**
     * Publishes three messages
     */
    result = interface.processRequest("publish", 
        {token, message: {topic: "/b/c", value: "1.0", reason: "test"} }, 
        {packetid: "0", qos: "1", version: '1.0'}
        );
    unitTest.assertEqual(result.headers.packetid, 0, "publish 1");
    // qos = 1
    result = interface.processRequest("publish", 
        {token, message: {topic: "/b/b", value: "1.0", reason: "test"} }, 
        {packetid: "1", qos: "1", dup: "1", version: '1.0'}
        );
    unitTest.assertEqual(result.headers.packetid, 1, "publish 2");    
    // qos = 2
    result = interface.processRequest("publish", 
        {token, message: {topic: "/b/2", value: "1.0", reason: "test"} }, 
        {packetid: "2", qos: "2", dup: "0", version: '1.0'}
        );
    unitTest.assertEqual(result.headers.packetid, 2, "publish 3");    
    // qos = 2, dup = 1, may not send a second message!
    result = interface.processRequest("publish", 
        {token, message: {topic: "/b/2", value: "1.0", reason: "test"} }, 
        {packetid: "2", qos: "2", dup: "1", version: '1.0'}
        );
    // Send the pubrel to free the packetid
    result = interface.processRequest("pubrel",  {token}, {packetid: "2", version: '1.0'});
    // qos = 2, dup = 1, now send it
    result = interface.processRequest("publish", 
        {token, message: {topic: "/b/2", value: "1.0", reason: "pubrel"} }, 
        {packetid: "2", qos: "2", dup: "1", version: '1.0'}
        );

    let packets = await processAllMessages();   
    unitTest.assertEqual(packets.publish, 3, "messages published");
    unitTest.assertEqual(packets.pubrel, 1, "pubrel message");

    // We need a second process loop, because we published two messages with the same
    // topic. It will not be send until we get the pubrel message
    packets = await processAllMessages();   
    unitTest.assertEqual(packets.publish, 1, "messages published");
    unitTest.assertEqual(packets.pubrel, 1, "pubrel message");

    interface.processSendMessage((host, port, packet, payload, headers) => {
        headers.packet = 'puback';
        unitTest.assertTrue(false, "unexpected message sent");
        return {statusCode: 204, headers, payload: {}};
    })
    unitTest.showResult(41);
})().catch((result) => {
    console.log(result); 
    console.log("fail");
} );

