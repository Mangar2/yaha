const Connect = require("@mangar2/connect");
const Publish = require("@mangar2/publish");
const UnitTest = require("@mangar2/unittest");
const Message = require("@mangar2/message");
const Broker = require("@mangar2/broker");

var unitTest = new UnitTest(true);

const config =  {       
    development: {
        broker : {
            port: 9001,
            persistInterval: 0
        },
        connections: {
            inFlightWindow: 1,
            timeoutInMilliseconds: 10000,
            maxRetryCount: 10,
            maxQueueSize: 1000,
            directory: ".",
            fileName: "broker",
            log: [
                {
                    module: "received",
                    topic: "/system/broker/#"
                }
            ]
        }
    }
}

let broker = new Broker(config);

(async function test() {    
    try {
        let result;
        broker.run();
        const CLEAN = true;
        const HOST = "127.0.0.1";
        // connect
        let connect = new Connect("/connect/test", HOST, config.development.broker.port, 9002);

        result = await connect.connect(CLEAN);
        unitTest.assertTrue(connect.isConnected, "successful connected");
        unitTest.assertEqual(result && result.present, 0, "No connection present");

        let publish = new Publish(HOST, config.development.broker.port, {retry: 3});
        let notAvailable = new Publish(HOST, 9003, {retry : 3});
        // publish QoS 0
        result = await publish.publish(new Message("/a/a", 1, "test"), 0, 0);
        unitTest.assertEqual(result, undefined, "QoS 0 message have undefined result");

        // publish QoS 1
        result = await publish.publish(new Message("/a/a", 1, "test"), 1, 0);
        unitTest.assertTrue(result, "QoS 1 message successful");

        // publish QoS 2
        //result = await publish.publish(new Message("/a/a", 1, "test"), 2, 0);
        //unitTest.assertTrue(result, "QoS 2 message successful");

        // QoS 1 on disconnect
        result = await notAvailable.publish(new Message("/a/a", 1, "test"), 1, 0);
        unitTest.assertTrue(!result, "QoS 1 message could not be delivered");

        unitTest.showResult(5);
        broker.close();
        //process.exit(0);
    }
    catch (err) {
        console.error(err);
        console.error("Error: test ends with errors")
        process.exit(1);
    }
})();

