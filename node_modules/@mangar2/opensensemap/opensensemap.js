/**
 * ---------------------------------------------------------------------------------------------------
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * File:      opensensemap.js
 *
 * Author:      Volker Böhm
 * Copyright:   Volker Böhm
 * ---------------------------------------------------------------------------------------------------
 */

'use strict'

const HttpsClient = require('@mangar2/httpservice').HttpsClient

/**
 * @typedef {object} Sensor
 * @property {string} name name of the sensor
 * @property {string} unit unit of the sensor
 * @property {string} topic topic the sensor is matched to
 * @property {string} id opensensmap unique id
 */

/**
 * @typedef {Sensor[]} Sensors array of sensors
 */

/**
 * @private
 * Searches a sensor-id in the "sensors" configuration
 * @param {Sensors} sensors array of sensor objects with "topic" and "id" attributes
 * @param {string} topic topic to search for
 * @returns {string|undefined} opensensmap unique id of the sensor or undefined if not found
 */
function lookupSensorId (sensors, topic) {
    let sensorId
    for (const sensor of sensors) {
        if (sensor.topic === topic) {
            sensorId = sensor.id
            break
        }
    }
    return sensorId
}

/**
 * Gets the topic to return
 * @param {number} statusCode http status code
 */
function getReturnTopic (statusCode) {
    let topic = ''
    switch (statusCode) {
    case 201: topic = '$SYS/opensensemap/success'; break
    case 404: topic = '$SYS/opensensemap/error/not found'; break
    case 422: topic = '$SYS/opensensemap/error/misdirected request'; break
    default: topic = '$SYS/opensensemap/error/' + statusCode
    }
    return topic
}

/**
 * @public
 * Publishes a value to the open sense map (you need an account to do this)
 * @param {string} topic topic to publish
 * @param {number} value value to publish
 * @param {object} config configuration (sensors, ...)
 * @param {string} config.id sensebox id (provided by open sens map)
 * @param {string} config.hostname hostnam of open sense map
 * @param {port} [config.port=443] portnumer of open sense map (usually 443)
 * @param {Sensors} config.sensors opensensemap sensor configuration
 * @returns {{statusCode: number, message: string}} statuscode and message of the http result
 */
async function publishToOpensensemap (topic, value, config) {
    const { hostname, port = 443 } = config
    const httpsClient = new HttpsClient(hostname, port)
    const sensorId = lookupSensorId(config.sensors, topic)
    if (sensorId === undefined) {
        throw Error('topic ' + topic + ' not found in open map sensors configuraiton ')
    }
    const data = { value }
    const payload = JSON.stringify(data)
    const headers = { 'content-type': 'application/json; charset=UTF-8' }
    const path = '/boxes/' + config.id + '/' + sensorId

    const httpResult = await httpsClient.send(path, 'POST', payload, headers)

    const result = {
        statusCode: httpResult.statusCode,
        topic: getReturnTopic(httpResult.statusCode)
    }
    if (headers['content-type'].startsWith('application/json')) {
        const jsonPayload = JSON.parse(httpResult.payload)
        result.message = jsonPayload.message !== undefined ? jsonPayload.message : jsonPayload
    }
    return result
}

module.exports = publishToOpensensemap
