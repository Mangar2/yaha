[
    {
        "description": "queue message, get an acknowledge",
        "tests": [
            {
                "description": "Simulate an enableSend message from device 2 to go to registered state",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "Send a message. It results in a message stored in the message queue waiting for enable send",
                "send": ["A", 1, 2, false],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "Simulate a received enable send, now the queued message will be send",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "Receive nothing, still enable send must be send",
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "Nothing to send, the queue ist empty, because non reply messages are not kept in the queue",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "Send a message, currently stored in the message store - now with reply set to true",
                "send": ["A", 1, 2, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "Simulate a received enable send, now the queued message with reply flag true will be send",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "The message has been sent, but is still in the queue because it waits for an acknowledge (reply=true)",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true  }
                ]
            },
            {
                "description": "Receive nothing, still enable send must be send (2)",
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "receive acknowledge, removing the message from the queue",
                "receive": ["A", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "message in no longer in the queue",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            }
        ]
    },
    {
        "description": "queue message, get no acknowledge",
        "tests": [
            {
                "description": "goto registered",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "queueMessage",
                "send": ["A", 1, 2, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "receive enable send",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue 2",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue 3",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue 4",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue 5",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue 6",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue 7",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue 8",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message is still in the queue 9",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "message in no longer in the queue",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            }
        ]
    },
    {
        "description": "queue two messages, get an acknowledge",
        "tests": [
            {
                "description": "Simulate an enableSend message from device 2 to go to registered state",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "queueMessage",
                "send": ["A", 1, 2, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "receive enable send",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "queueMessage to 3",
                "send": ["A", 1, 3, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "message is still in the queue",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "receive acknowledge",
                "receive": ["A", 2, 1, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "send next message of the queue",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 3, "reply": true }
                ]
            }
        ]
    },
    {
        "description": "queue two messages, seond is replacing first, get an acknowledge",
        "tests": [
            {
                "description": "goto registered",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "queueMessage",
                "send": ["A", 1, 2, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "receive enable send",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "replace message",
                "send": ["A", 1, 2, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "message is still in the queue",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "receive acknowledge",
                "receive": ["A", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "message in no longer in the queue",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            }
        ]
    },
    {
        "description": "queue two messages, seond is not replacing first",
        "tests": [
            {
                "description": "goto registered",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "queueMessage, command 'A'",
                "send": ["A", 1, 2, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "receive enable send",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "add second message, do not replace",
                "send": ["B", 1, 2, true],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "Send first message again",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "A", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "receive acknowledge for first message",
                "receive": ["A", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "Send second message",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "B", "sender": 1, "receiver": 2, "reply": true }
                ]
            },
            {
                "description": "receive acknowledge for second message",
                "receive": ["B", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            },
            {
                "description": "The queue is now empty",
                "receive": ["enableSend", 2, 1],
                "messageAmount": 1,
                "expected": [
                    {"command": "enableSend", "sender": 1, "receiver": 2 }
                ]
            }
        ]
    }
]