/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2020 Volker Böhm
 */

'use strict'

const types = require('@mangar2/types')
const fs = require('fs')
const errorLog = require('@mangar2/errorlog')

let automation

/**
 * @private
 * @description Get/reads rules from files
 * @param {string|Array} rules rules information.
 * If type is string, rules are read from a file with the filename
 * If type is Array, rules are read from an array of files (filenames)
 * @returns {Object} set of rules
 */
function readRules (filenames) {
    let result = {}
    if (types.isString(filenames)) {
        result = JSON.parse(fs.readFileSync(filenames))
    } else if (types.isArray(filenames)) {
        result = {}
        try {
            for (const fileName of filenames) {
                const fileRules = JSON.parse(fs.readFileSync(fileName))
                result = { ...result, ...fileRules }
            }
        } catch (err) {
            errorLog(err)
        }
    }
    return result
}

/**
 * Watches rule files and reloads them on change
 * @param {Array|string} filenames name of the rule file(s)
 */
/*
function watchRules (filenames) {
    if (types.isString(filenames)) {
        filenames = [filenames]
    }
    for (const filename of filenames) {
        fs.watch(filename, { }, (eventType, filename) => {
            const rules = readRules(filenames)
            automation = new Motion(config.motion, rules)
            const subscriptions = automation.getSubscriptions()
            mqttClient.subscriptions = subscriptions
        })
    }
}
*/

/**
 * @private
 * @description Registers the automation service, if the configuration demands it
 * @param {MqttClient} mqttClient client providing mqtt services
 * @param {Object} config configuration data
 * @param {Object} config.motion configuration for the motion service
 * @param {Array} config.runservices.services configured services to install
 */
function registerMotion (mqttClient, config) {
    if (config.motion && config.runservices.services.includes('motion')) {
        try {
            const Motion = require('@mangar2/motion')
            // watchRules()
            automation = new Motion(config.motion)

            const rules = readRules(config.motion.rules)
            automation.setRules(rules)

            console.log('checking motion rules ...')
            const subscriptions = automation.getSubscriptions()

            mqttClient.registerRecipient(subscriptions, (message) => {
                const setResponse = automation.processMessage(message)
                const result = automation.processRules()
                const messages = [...result.messages, ...setResponse]
                return messages
            })
            mqttClient.registerSender(config.motion.intervalInSeconds * 1000, async () => {
                const result = automation.processRules()
                return result.messages
            })

            console.log('started motion service')
        } catch (err) {
            errorLog(err, false)
        }
    }
}

module.exports = registerMotion
