/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2020 Volker Böhm
 */

'use strict'

const Message = require('@mangar2/message')
const { SWITCH_ON, SWITCH_OFF } = require('./constants')

/**
 * "Domain name service" with the ability to convert serial messages in mqtt messages and vice versa
 * @param {Object} options matching options
 * @param {Object} options.settings setting commands
 * @param {Object} options.status status commands
 * @param {Object} options.topics full topic command/value settings
 * @param {Object} options.addresses location addresses
 * @param {Object} options.interfaces interface defintions
 * @param {integer} options.myAddress sender address
 * @private
 */
class SerialToMQTT {
    constructor (options) {
        this._options = options
    }

    /**
     * Determines the value to set, depending of the command and the value. It looks up the
     * interface defintions to map strings (like 'on' or 'off') to dedicated values and just returns
     * the mqttValue on any number
     * @param {char} command one character string containing the command
     * @returns {number|string} value to be send in a mqtt message
     * @private
     */
    _toMqttValue (command, serialValue) {
        let result = serialValue

        for (const interfaceName in this._options.interfaces) {
            const arduinoInterface = this._options.interfaces[interfaceName]
            if (arduinoInterface.usedby.includes(command)) {
                for (const interfaceValue in arduinoInterface.map) {
                    if (arduinoInterface.map[interfaceValue] === serialValue) {
                        result = interfaceValue
                        break
                    }
                }
            }
        }

        return result
    }

    /**
     * Gets the begin of the topic derived from the serial address
     * @param {integer} serialAddress address of a serial device
     * @returns {string} begin of the topic
     * @throws {Error} if the serial address is unknown
     * @private
     */
    _getTopicBeginUsingSerialAddress (serialAddress) {
        let result
        for (const topicBegin in this._options.addresses) {
            const address = this._options.addresses[topicBegin]
            if (serialAddress === address) {
                result = topicBegin
            }
        }
        if (result === undefined) {
            throw Error('Unknown serial address: ' + serialAddress)
        }
        return result
    }

    /**
     * Gets the end of the topic derived from the serial command
     * @param {string} serialCommand command of a serial message
     * @returns {string} end of the topic
     * @throws {Error} if the serial command is unknown
     * @private
     */
    _getTopicEndUsingSerialCommand (serialCommand) {
        let result
        const settings = this._options.settings[serialCommand]
        if (settings) {
            result = settings
        } else {
            const status = this._options.status[serialCommand]
            if (status) {
                result = status
            }
        }
        if (result === undefined) {
            throw Error('Unknown serial command: ' + serialCommand)
        }
        return result
    }

    /**
     * Gets the topic derived from a serial message
     * @param {Object} serialMessage received serial message
     * @returns {string} topic
     * @throws {Error} If the topic cannot be derived due to wrong or not configured elements
     * @private
     */
    _getTopicUsingSerialMessage (serialMessage) {
        const topic =
            this._getTopicBeginUsingSerialAddress(serialMessage.sender) +
            this._getTopicEndUsingSerialCommand(serialMessage.command)
        return topic
    }

    /**
     * Check, if we can get mqtt messages from the "topics" interface of options
     * @param {SerialMessage} serialMessage received serial message
     * @returns {Message[]} list of mqtt messages to send to broker
     * @private
     */
    _getMqttMessageOnSwitchMessages (serialMessage) {
        const result = []
        const { command, sender, value } = serialMessage
        for (const topic in this._options.topics) {
            const requiredSerialData = this._options.topics[topic]
            if (command === requiredSerialData.command && sender === requiredSerialData.address) {
                const isSwitchOnMessage = (value & SWITCH_ON) !== 0
                const isSwitchOffMessage = (value & SWITCH_OFF) !== 0
                const isSwitchMessage = isSwitchOnMessage || isSwitchOffMessage
                const bitIsSet = (value & requiredSerialData.value) !== 0
                if (!isSwitchMessage) {
                    const mqttValue = bitIsSet ? 'on' : 'off'
                    result.push(new Message(topic, mqttValue, 'received from arduino'))
                } else if (bitIsSet) {
                    const mqttValue = isSwitchOffMessage ? 'off' : 'on'
                    result.push(new Message(topic, mqttValue, 'received from arduino'))
                }
            }
        }
        return result
    }

    /**
     * Converts a serial message to mqtt messages
     * @param {SerialMessage} serialMessage received serial object
     * @returns {Message[]} Mqtt messages
     * @throws {Error} If the message cannot be derived due to wrong or not configured elements
     */
    toMqttMessages (serialMessage) {
        const result = this._getMqttMessageOnSwitchMessages(serialMessage)
        const isSwitchMessage = result.length !== 0
        if (!isSwitchMessage) {
            const { command, value } = serialMessage
            const message = new Message(
                this._getTopicUsingSerialMessage(serialMessage),
                this._toMqttValue(command, value),
                'received from arduino'
            )
            result.push(message)
        }
        return result
    }
}

module.exports = SerialToMQTT
