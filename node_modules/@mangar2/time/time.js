/**
 * @license
 * This software is licensed under the GNU LESSER GENERAL PUBLIC LICENSE Version 3. It is furnished
 * "as is", without any support, and with no warranty, express or implied, as to its usefulness for
 * any purpose.
 *
 * @author Volker Böhm
 * @copyright Copyright (c) 2020 Volker Böhm
 */

'use strict'

/**
 * Converts a time string in format HH:MM or HH:MM:SS or MMM to seconds
 * @param {string} timeString delta time
 * @throws {Error} on false date format
 * @returns {number} time string in seconds
 */
function stringToSeconds (timeString) {
    let minus = 1
    let result = 0
    if (timeString.length > 0 && timeString.charAt(0) === '-') {
        minus = -1
        timeString = timeString.substr(1)
    }
    const timeChunks = timeString.trim().split(':')

    for (let index = 0; index < timeChunks.length; index++) {
        timeChunks[index] = parseInt(timeChunks[index])
        if (!Number.isInteger(timeChunks[index])) {
            throw Error('Illegal time format: ' + timeString)
        }
    }

    if (timeChunks.length === 1) {
        result = timeChunks[0] * 60
    } else if (timeChunks.length >= 2) {
        result = timeChunks[0] * 60 * 60
        result += timeChunks[1] * 60
        if (timeChunks.length === 3) {
            result += timeChunks[2]
        }
    }
    result *= minus
    return result
}

/**
 * Checks, if a string is a time of day string (HH:MM or HH:MM:SS)
 * @param {string} timeString delta time
 * @returns {boolean} true, if the string is a time of day string
 */
function isTimeOfDayString (timeString) {
    const timeChunks = timeString.trim().split(':')
    let result = timeChunks.length > 1 && timeChunks.length <= 3
    let maxInt = 23
    for (let chunk of timeChunks) {
        chunk = parseInt(chunk)
        if (!Number.isInteger(chunk) || chunk < 0 || chunk > maxInt) {
            result = false
            break
        }
        maxInt = 59
    }
    return result
}

/**
 * Converts a time string in format HH:MM or HH:MM:SS or MMM to a date (today, same time of day)
 * @param {string} timeString time of day
 * @throws {Error} on false time format
 * @returns {Date} today, hours, minutes, seconds set to the time of day string
 */
function timeOfDayStringToDate (timeString) {
    const result = new Date()
    const seconds = timeString === undefined ? 0 : stringToSeconds(timeString)
    result.setHours(0, 0, seconds, 0)
    return result
}

/**
 * Gets the seconds since midnight of a date.
 * @param {Date} date date to concider
 * @returns {number} amount of seconds passed since midnight
 */
function dateToTimeOfDayInSeconds (date) {
    const midnight = new Date(date)
    midnight.setHours(0, 0, 0)
    const result = (date - midnight) / 1000
    return result
}

module.exports = {
    isTimeOfDayString,
    stringToSeconds,
    timeOfDayStringToDate,
    dateToTimeOfDayInSeconds
}
